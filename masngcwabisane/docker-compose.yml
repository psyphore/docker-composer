# docker compose -f docker-compose.yml up --force-recreate --build -d

# docker compose -f docker-compose.yml build [services]
# docker compose -f docker-compose.yml up --no-deps -d [services]

# docker compose -f docker-compose.yml down

version: "3.9"

# networks:
#   infrastructure:
#   frontend:
#   backend:

# volumes: 
#   n4j:

services:

  database:
    container_name: n4j-e
    image: docker.io/neo4j:4.4-enterprise
    # volumes:
    #   - ${NEO4J_path}\data:/var/lib/neo4j/data
    #   - ${NEO4J_path}\logs:/var/lib/neo4j/logs
    #   - ${NEO4J_path}\conf:/var/lib/neo4j/conf
    #   - ${NEO4J_path}\plugins:/var/lib/neo4j/plugins
    #   - ${NEO4J_path}\import:/var/lib/neo4j/import
    #   - ${NEO4J_path}\certificates:/var/lib/neo4j/certificates
    #   - ${NEO4J_path}\run:/var/lib/neo4j/run
    ports:
      - ${NEO4J_HTTP}:7474   # Http protocol - Used by the Neo4j Browser. Also used by REST API. (Development)
      - ${NEO4J_BOLT}:7687   # Bolt protocol - Used by Cypher Shell and by the Neo4j Browser.
      # - ${NEO4J_HTTPS}:7473  # Https protocol - Used by the Neo4j Browser. Also used by REST API. (Production)
    environment:
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=$NEO4J_ACCEPT_LICENSE_AGREEMENT
      - NEO4J_AUTH=$NEO4J_AUTH
      - NEO4JLABS_PLUGINS=$NEO4JLABS_PLUGINS
      - NEO4J_dbms_security_procedures_unrestricted=$NEO4J_dbms_security_procedures_unrestricted
      - NEO4J_dbms_security_procedures_allowlist=$NEO4J_dbms_security_procedures_allowlist
      - NEO4J_dbms_allow_upgrade=$NEO4J_dbms_allow_upgrade
      - NEO4J_dbms_backup_enabled=$NEO4J_dbms_backup_enabled
      - NEO4J_apoc_export_file_enabled=$NEO4J_apoc_export_file_enabled
      - NEO4J_apoc_import_file_enabled=$NEO4J_apoc_import_file_enabled
      - NEO4J_apoc_import_file_use__neo4j__config=$NEO4J_apoc_import_file_use__neo4j__config
      - NEO4J_dbms_memory_pagecache_size=$NEO4J_dbms_memory_pagecache_size
    restart: unless-stopped
    depends_on: 
      - telemetry
  
  bpm:
    container_name: worklow
    image: docker.io/camunda/camunda-bpm-platform:latest
    command: './camunda.sh --rest --webapps --swaggerui'
    restart: unless-stopped
    ports:
      - 8081:8080

  telemetry:
    container_name: seq-metrics
    image: docker.io/datalust/seq:latest
    ports:
      - ${SEQ_UI_PORT}:80
      - ${SEQ_API_PORT}:5341
      - ${SEQ_HTTPS_UI_PORT}:443
      - ${SEQ_HTTPS_API_PORT}:45341
    environment:
      - ACCEPT_EULA=Y
    restart: unless-stopped
    depends_on: 
      - cache

  cache:
    container_name: cache
    image: docker.io/redis:alpine
    command: ${REDIS_ARGS}
    restart: unless-stopped

  mail-server:
    container_name: email
    image: docker.io/mailhog/mailhog:latest
    restart: unless-stopped
    ports:
      - 1025:1025
      - 8025:8025
    environment:
      - MH_HOSTNAME=thumbezatech.masngwabisane
      - MH_CORS_ORIGIN=*

  zookeeper:
    container_name: zookeeper
    image: docker.io/confluentinc/cp-zookeeper:7.1.1
    hostname: zookeeper
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  broker:
    container_name: broker
    image: docker.io/confluentinc/cp-kafka:7.1.1
    restart: unless-stopped
    command: ["kafka-topics", "--create", "--topic purchases", "--topic purchases-ack", "--bootstrap-server localhost:9092", "--replication-factor 1", "--partitions 1"]
    ports:
      - ${KAFKA_BROKER_PORT}:9092
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:${KAFKA_ZOOKEPPER_PORT}'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,PLAINTEXT_INTERNAL://broker:29092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1

  akhq:
    container_name: kafka-ui
    image: docker.io/tchiotludo/akhq:latest
    restart: unless-stopped
    ports:
      - ${KAFKA_UI_PORT}:8080